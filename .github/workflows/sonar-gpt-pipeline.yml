name: analyze

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner

      - name: Begin SonarQube Scan
        run: dotnet-sonarscanner begin /k:"eshop-web-dotnet8" /d:sonar.login="${{ secrets.SONAR_TOKEN }}" /d:sonar.host.url="http://13.89.226.182/:9000"

      - name: Build Solution
        run: dotnet build YourSolution.sln --no-incremental

      - name: End SonarQube Scan
        run: dotnet-sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"

      - name: Run ESLint for Frontend
        run: |
          cd client
          npx eslint src/app/**/*.ts --config eslint.config.js --format json -o ../frontend_lint.json

      - name: Merge Sonar and ESLint results
        run: python merge_reports.py

      - name: Invoke GPT-4 Summary via Azure Function
        run: |
          curl -X POST           -H "Content-Type: application/json"           -d @sonar_issues.json           ${{ secrets.AZURE_FUNCTION_ENDPOINT }}

      - name: Upload files to Azure Blob Storage
        run: |
          az storage blob upload --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }}                                  --container-name gpt-summaries                                  --name sonar_issues.json                                  --file sonar_issues.json                                  --sas-token "${{ secrets.AZURE_SAS_TOKEN }}"

          az storage blob upload --account-name ${{ secrets.AZURE_STORAGE_ACCOUNT }}                                  --container-name gpt-summaries                                  --name summary.md                                  --file summary.md                                  --sas-token "${{ secrets.AZURE_SAS_TOKEN }}"
